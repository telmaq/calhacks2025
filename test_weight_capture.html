<!DOCTYPE html>
<html>
  <head>
    <title>FarmFresh Marketplace - Weight Capture</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #f0f8f0 0%, #e8f5e8 100%);
        color: #2c3e2c;
        min-height: 100vh;
        padding: 20px;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      .header h1 {
        color: #2c3e2c;
        font-size: 2.2em;
        margin-bottom: 10px;
        font-weight: 600;
      }

      .header .subtitle {
        color: #5a7c5a;
        font-size: 1.1em;
        font-weight: 300;
      }

      .farm-icon {
        font-size: 2.5em;
        margin-bottom: 15px;
        display: block;
      }

      #container {
        max-width: 700px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
      }

      .camera-section {
        margin-bottom: 25px;
      }

      video {
        width: 100%;
        border-radius: 15px;
        border: 3px solid #a8d5a8;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .form-section {
        background: #f8fdf8;
        padding: 25px;
        border-radius: 15px;
        margin: 20px 0;
        border: 2px solid #d4e6d4;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        color: #2c3e2c;
        font-weight: 500;
        font-size: 1.1em;
      }

      select,
      input {
        padding: 12px 15px;
        margin: 0;
        width: 100%;
        background: #ffffff;
        color: #2c3e2c;
        border: 2px solid #d4e6d4;
        border-radius: 10px;
        font-size: 16px;
        transition: all 0.3s ease;
      }

      select:focus,
      input:focus {
        outline: none;
        border-color: #7fb069;
        box-shadow: 0 0 0 3px rgba(127, 176, 105, 0.2);
      }

      .button-group {
        text-align: center;
        margin: 25px 0;
      }

      button {
        padding: 15px 35px;
        font-size: 18px;
        margin: 10px;
        background: linear-gradient(135deg, #7fb069 0%, #6a9c5a 100%);
        color: white;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(127, 176, 105, 0.3);
        min-width: 180px;
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(127, 176, 105, 0.4);
        background: linear-gradient(135deg, #6a9c5a 0%, #5a8c4a 100%);
      }

      button:active {
        transform: translateY(0);
      }

      .status {
        padding: 20px;
        margin: 20px 0;
        border-radius: 12px;
        background: #f8fdf8;
        border: 2px solid #d4e6d4;
        min-height: 60px;
        font-size: 1.1em;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        transition: all 0.3s ease;
      }

      .success {
        background: linear-gradient(135deg, #d4f0d4 0%, #c8e8c8 100%);
        border-color: #7fb069;
        color: #2c5a2c;
      }

      .error {
        background: linear-gradient(135deg, #f8d4d4 0%, #f0c8c8 100%);
        border-color: #d67b7b;
        color: #5a2c2c;
      }

      .loading {
        background: linear-gradient(135deg, #f0f0f0 0%, #e8e8e8 100%);
        border-color: #ccc;
        color: #666;
      }

      .farm-decoration {
        text-align: center;
        margin: 20px 0;
        font-size: 1.5em;
        color: #7fb069;
      }

      @media (max-width: 768px) {
        body {
          padding: 10px;
        }

        #container {
          padding: 20px;
          margin: 10px;
        }

        .header h1 {
          font-size: 1.8em;
        }

        button {
          width: 100%;
          margin: 10px 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>FarmFresh Marketplace</h1>
      <p class="subtitle">Smart Weight Capture for Family Farms</p>
    </div>

    <div id="container">
      <div class="camera-section">
        <video id="video" autoplay></video>
      </div>

      <div class="form-section">
        <div class="form-group">
          <label for="cameraSelect">Select Camera</label>
          <select id="cameraSelect">
            <option value="">Choose your camera...</option>
          </select>
        </div>

        <div class="form-group">
          <label for="farmerId">Farmer ID</label>
          <input
            type="text"
            id="farmerId"
            placeholder="Enter your farmer ID (e.g., farmer123)"
            value="farmerxxx"
          />
        </div>

        <div class="form-group">
          <label for="produceName">Produce Name</label>
          <input
            type="text"
            id="produceName"
            placeholder="What are you weighing? (e.g., organic tomatoes)"
            value="xxx"
          />
        </div>
      </div>

      <div class="button-group">
        <button onclick="captureWeight()">Capture Weight</button>
      </div>

      <div class="farm-decoration">FarmFresh Marketplace</div>

      <div class="status" id="status">
        Enter your farmer ID and produce name, then capture the weight
      </div>
    </div>

    <script>
      let stream = null;
      let devices = [];

      async function loadCameras() {
        try {
          // Request permission first to get device labels
          updateStatus("Requesting camera access...", "");
          await navigator.mediaDevices.getUserMedia({ video: true });

          // Now enumerate devices (they'll have labels now)
          devices = await navigator.mediaDevices.enumerateDevices();
          const videoDevices = devices.filter(
            (device) => device.kind === "videoinput"
          );

          const cameraSelect = document.getElementById("cameraSelect");
          cameraSelect.innerHTML = '<option value="">Select Camera...</option>';

          let c270DeviceId = null;

          videoDevices.forEach((device, index) => {
            const option = document.createElement("option");
            option.value = device.deviceId;
            option.textContent = device.label || `Camera ${index + 1}`;
            cameraSelect.appendChild(option);

            // Check if this is the C270 webcam
            if (device.label && device.label.toLowerCase().includes("c270")) {
              c270DeviceId = device.deviceId;
            }
          });

          // Auto-select C270 if found
          if (c270DeviceId) {
            cameraSelect.value = c270DeviceId;
            startCamera(c270DeviceId);
          } else {
            updateStatus("Select a camera from the dropdown", "");
          }
        } catch (error) {
          console.error("Error loading cameras:", error);
          const errorMsg =
            error.name === "NotAllowedError"
              ? 'Camera permission denied. Please click "Allow" when prompted.'
              : `Error: ${error.message}`;
          updateStatus(errorMsg, "error");
        }
      }

      async function startCamera(deviceId = null) {
        try {
          if (stream) {
            stream.getTracks().forEach((track) => track.stop());
          }

          const constraints = {
            video: deviceId ? { deviceId: { exact: deviceId } } : true
          };

          stream = await navigator.mediaDevices.getUserMedia(constraints);
          const video = document.getElementById("video");
          video.srcObject = stream;
          updateStatus("Camera connected", "success");
        } catch (error) {
          console.error("Camera error:", error);
          const errorMsg =
            error.name === "NotAllowedError"
              ? "Camera permission denied. Please allow camera access and refresh."
              : `Camera error: ${error.message}`;
          updateStatus(errorMsg, "error");
        }
      }

      function updateStatus(msg, type = "") {
        const status = document.getElementById("status");
        status.textContent = msg;
        status.className = "status " + type;

        // Add loading animation for certain messages
        if (msg.includes("Capturing") || msg.includes("Requesting")) {
          status.className = "status loading";
        }
      }

      async function captureWeight() {
        const farmerId = document.getElementById("farmerId").value;
        const produceName = document.getElementById("produceName").value;

        if (!farmerId || !produceName) {
          updateStatus("Please enter farmer ID and produce name", "error");
          return;
        }

        updateStatus("Capturing image...");

        // Capture frame
        const video = document.getElementById("video");
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0);

        // Convert to base64
        const imageData = canvas.toDataURL("image/jpeg", 0.7);
        const base64 = imageData.split(",")[1];

        // Send to API
        try {
          // Use current origin (works for localhost and Railway)
          const apiUrl = `${window.location.origin}/api/v1/capture/weight`;

          const response = await fetch(apiUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              farmer_id: farmerId,
              produce_name: produceName,
              image_base64: base64
            })
          });

          const data = await response.json();

          if (response.ok) {
            updateStatus(
              `✅ Product saved: ${data.name} - ${data.price} ${data.unit}`,
              "success"
            );
            console.log("Response:", data);

            // Send data back to Creao (if opened from Creao)
            if (window.opener) {
              window.opener.postMessage(
                {
                  type: "produce_captured",
                  data: data
                },
                "*"
              ); // Replace '*' with specific Creao domain in production
              console.log("✅ Data sent to Creao");

              // Close window after 2 seconds
              setTimeout(() => {
                updateStatus("✅ Closing window...", "success");
                setTimeout(() => window.close(), 1000);
              }, 2000);
            }
          } else {
            updateStatus(`❌ Error: ${data.error}`, "error");
          }
        } catch (error) {
          updateStatus(`❌ Network error: ${error.message}`, "error");
        }
      }

      // Load cameras (will auto-start C270 if found)
      loadCameras();

      // Handle camera selection change
      document
        .getElementById("cameraSelect")
        .addEventListener("change", function () {
          const selectedDeviceId = this.value;
          if (selectedDeviceId) {
            startCamera(selectedDeviceId);
          }
        });
    </script>
  </body>
</html>
