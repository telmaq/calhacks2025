<!DOCTYPE html>
<html>
  <head>
    <title>Weight Capture Test</title>
    <style>
      body {
        font-family: Arial;
        margin: 20px;
        background: #000;
        color: #fff;
      }
      #container {
        max-width: 600px;
        margin: 0 auto;
      }
      video {
        width: 100%;
        border: 2px solid #333;
      }
      button {
        padding: 15px 30px;
        font-size: 16px;
        margin: 10px 5px;
        background: #007aff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      input {
        padding: 10px;
        margin: 10px 0;
        width: 100%;
        background: #222;
        color: #fff;
        border: 1px solid #555;
        border-radius: 5px;
      }
      .status {
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
        background: #333;
        min-height: 50px;
      }
      .success {
        background: #0a3;
      }
      .error {
        background: #a30;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <h1>üì∏ Weight Capture Test</h1>

      <video id="video" autoplay></video>

      <div>
        <select
          id="cameraSelect"
          style="
            padding: 10px;
            margin: 10px 0;
            width: 100%;
            background: #222;
            color: #fff;
            border: 1px solid #555;
            border-radius: 5px;
          "
        >
          <option value="">Select Camera...</option>
        </select>
        <input
          type="text"
          id="farmerId"
          placeholder="Farmer ID (e.g., farmer123)"
          value="farmer123"
        />
        <input
          type="text"
          id="produceName"
          placeholder="Produce Name (e.g., apples)"
          value="apples"
        />
      </div>

      <div>
        <button onclick="captureWeight()">Capture Weight</button>
      </div>

      <div class="status" id="status">
        Enter farmer ID and produce name, then capture
      </div>
    </div>

    <script>
      let stream = null;
      let devices = [];

      async function loadCameras() {
        try {
          // Request permission first to get device labels
          updateStatus("Requesting camera access...", "");
          await navigator.mediaDevices.getUserMedia({ video: true });

          // Now enumerate devices (they'll have labels now)
          devices = await navigator.mediaDevices.enumerateDevices();
          const videoDevices = devices.filter(
            (device) => device.kind === "videoinput"
          );

          const cameraSelect = document.getElementById("cameraSelect");
          cameraSelect.innerHTML = '<option value="">Select Camera...</option>';

          let c270DeviceId = null;

          videoDevices.forEach((device, index) => {
            const option = document.createElement("option");
            option.value = device.deviceId;
            option.textContent = device.label || `Camera ${index + 1}`;
            cameraSelect.appendChild(option);

            // Check if this is the C270 webcam
            if (device.label && device.label.toLowerCase().includes("c270")) {
              c270DeviceId = device.deviceId;
            }
          });

          // Auto-select C270 if found
          if (c270DeviceId) {
            cameraSelect.value = c270DeviceId;
            startCamera(c270DeviceId);
          } else {
            updateStatus("Select a camera from the dropdown", "");
          }
        } catch (error) {
          console.error("Error loading cameras:", error);
          const errorMsg =
            error.name === "NotAllowedError"
              ? 'Camera permission denied. Please click "Allow" when prompted.'
              : `Error: ${error.message}`;
          updateStatus(errorMsg, "error");
        }
      }

      async function startCamera(deviceId = null) {
        try {
          if (stream) {
            stream.getTracks().forEach((track) => track.stop());
          }

          const constraints = {
            video: deviceId ? { deviceId: { exact: deviceId } } : true
          };

          stream = await navigator.mediaDevices.getUserMedia(constraints);
          const video = document.getElementById("video");
          video.srcObject = stream;
          updateStatus("Camera connected", "success");
        } catch (error) {
          console.error("Camera error:", error);
          const errorMsg =
            error.name === "NotAllowedError"
              ? "Camera permission denied. Please allow camera access and refresh."
              : `Camera error: ${error.message}`;
          updateStatus(errorMsg, "error");
        }
      }

      function updateStatus(msg, type = "") {
        const status = document.getElementById("status");
        status.textContent = msg;
        status.className = "status " + type;
      }

      async function captureWeight() {
        const farmerId = document.getElementById("farmerId").value;
        const produceName = document.getElementById("produceName").value;

        if (!farmerId || !produceName) {
          updateStatus("Please enter farmer ID and produce name", "error");
          return;
        }

        updateStatus("Capturing image...");

        // Capture frame
        const video = document.getElementById("video");
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0);

        // Convert to base64
        const imageData = canvas.toDataURL("image/jpeg", 0.7);
        const base64 = imageData.split(",")[1];

        // Send to API
        try {
          // Use current origin (works for localhost and Railway)
          const apiUrl = `${window.location.origin}/api/v1/capture/weight`;

          const response = await fetch(apiUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              farmer_id: farmerId,
              produce_name: produceName,
              image_base64: base64
            })
          });

          const data = await response.json();

          if (response.ok) {
            updateStatus(`‚úÖ ${data.message}`, "success");
            console.log("Response:", data);
          } else {
            updateStatus(`‚ùå Error: ${data.error}`, "error");
          }
        } catch (error) {
          updateStatus(`‚ùå Network error: ${error.message}`, "error");
        }
      }

      // Load cameras (will auto-start C270 if found)
      loadCameras();

      // Handle camera selection change
      document
        .getElementById("cameraSelect")
        .addEventListener("change", function () {
          const selectedDeviceId = this.value;
          if (selectedDeviceId) {
            startCamera(selectedDeviceId);
          }
        });
    </script>
  </body>
</html>
